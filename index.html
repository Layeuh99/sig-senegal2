<!doctype html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/MarkerCluster.css">
        <link rel="stylesheet" href="css/MarkerCluster.Default.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet-minimap@3.6.1/dist/Control.MiniMap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        #navbar {
            z-index: 1000;
            background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-bottom: 3px solid #00d4ff;
        }
        #navbar .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 1px;
            color: #00d4ff !important;
        }
        #map {
            height: calc(100vh - 56px);
            width: calc(100% - 520px);
            margin-left: 280px;
            margin-right: 240px;
        }
        .sidebar {
            position: fixed;
            top: 56px;
            bottom: 0;
            width: 280px;
            z-index: 100;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.98) 0%, rgba(245, 247, 250, 0.98) 100%);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .sidebar.left {
            left: 0;
            border-right: 2px solid #e0e7ff;
        }
        .sidebar.right {
            right: 0;
            width: 240px;
            border-left: 2px solid #e0e7ff;
        }
        .sidebar.collapsed {
            display: none;
        }
        .sidebar.right.collapsed {
            display: none;
        }
        .sidebar-content {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }
        .sidebar-content h5 {
            color: var(--text-color);
            font-weight: 700;
        }
        /* Visual theme: vibrant palette and animated clusters */
        :root {
            --accent-1: #ff6b6b;
            --accent-2: #ffd166;
            --accent-3: #6bcB77;
            --accent-4: #4da6ff;
            --accent-5: #9b59b6;
            --control-bg: rgba(255,255,255,0.95);
            --muted-color: #666;
            --error-color: #e74c3c;
            --success-color: #27ae60;
        }
        .leaflet-control {
            box-shadow: 0 6px 18px rgba(16,24,40,0.15);
            border-radius: 8px;
            background: var(--control-bg);
        }
        .leaflet-tooltip.css_Region_1 {
            background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            color: var(--tooltip-text-color);
            font-weight: 700;
            padding: 6px 8px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(6, 10, 24, 0.15);
            border: 1px solid rgba(0,0,0,0.06);
        }
        .leaflet-tooltip.css_localites_5 {
            background: rgba(0,0,0,0.8);
            color: var(--tooltip-text-color);
            padding: 4px 6px;
            border-radius: 6px;
            font-weight: 600;
        }
        /* Cluster appearance */
        .marker-cluster-small { background: linear-gradient(135deg,#4da6ff,#6bcB77); color: #fff; }
        .marker-cluster-medium { background: linear-gradient(135deg,#ffd166,#ff9f43); color: #222; }
        .marker-cluster-large { background: linear-gradient(135deg,#ff6b6b,#ff3b3b); color: #fff; }
        .marker-cluster-xlarge { background: radial-gradient(circle at 30% 30%, #ff3b3b 0%, #c81d25 50%, #8b0f12 100%); color: #fff; box-shadow: 0 6px 18px rgba(200,30,30,0.35); }
        .marker-cluster div { border-radius: 50%; width: 48px; height: 48px; display:flex; align-items:center; justify-content:center; box-shadow: 0 6px 14px rgba(0,0,0,0.25); }
        .marker-cluster span { font-weight: 800; font-size: 1.05rem; }

        /* Theme overrides (dark) and animations toggles */
        /* Theme: Claire (clair / light) -- lisible et neutre */
        .theme-claire {
            --control-bg: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,255,0.95));
            --accent-1: #ff6b6b; /* soft rose */
            --accent-2: #ffd166; /* warm gold */
            --accent-3: #6bcB77; /* mint */
            --accent-4: #4da6ff; /* sky */
            --accent-5: #9b59b6; /* purple */
            --text-color: #0b2447;
            --tooltip-text-color: #323232;
            background: linear-gradient(180deg,#fff,#f6fbff);
            color: var(--text-color);
        }
        .theme-claire .sidebar, .theme-claire .control-card { border-left: 3px solid rgba(77,166,255,0.06); }
        .theme-claire .leaflet-tooltip.css_Region_1 { background: linear-gradient(90deg, rgba(255,255,255,0.98), rgba(248,249,255,0.98)); color: #0b2447; }
        /* Navbar subtle gradient for Claire theme */
        .theme-claire { --navbar-bg: linear-gradient(90deg, rgba(77,166,255,0.10), rgba(255,255,255,0.00)); }

        /* Navbar base styling (subtle, keeps existing colors) */
        .navbar {
            background: var(--navbar-bg, linear-gradient(90deg, rgba(77,166,255,0.08), rgba(255,255,255,0.00)));
            box-shadow: 0 2px 10px rgba(6, 12, 30, 0.06);
            transition: background 0.35s ease, box-shadow 0.35s ease;
            backdrop-filter: blur(4px);
        }

        /* Theme: Dark -- deep contrast, neon accents (text forced white) */
        .theme-dark {
            --control-bg: rgba(8,10,16,0.96);
            --accent-1: #ff6b6b; /* warm red */
            --accent-2: #ffd166;
            --accent-3: #00e6b8; /* neon */
            --accent-4: #5bb0ff;
            --accent-5: #c085ff;
            --text-color: #ffffff;
            --tooltip-text-color: #ffffff;
            --navbar-bg: linear-gradient(90deg, rgba(8,12,20,0.98), rgba(10,14,20,0.92));
            background: radial-gradient(circle at 10% 10%, #071022 0%, #03040a 100%);
            color: var(--text-color) !important;
        }
        /* Ensure primary UI text is white in dark mode */
        .theme-dark, .theme-dark body, .theme-dark .navbar, .theme-dark .sidebar, .theme-dark .sidebar-content, .theme-dark .control-card, .theme-dark .query-modal-content, .theme-dark .toast-message {
            color: #ffffff !important;
        }
        .theme-dark .sidebar, .theme-dark .leaflet-control, .theme-dark .control-card {
            background: rgba(8,12,20,0.94) !important;
            color: #ffffff !important;
            border-color: rgba(255,255,255,0.04) !important;
            box-shadow: 0 12px 40px rgba(0,0,0,0.6) !important;
        }
        .theme-dark .leaflet-tooltip.css_Region_1 { background: linear-gradient(90deg, rgba(8,12,20,0.95), rgba(18,22,28,0.9)) !important; color: #ffffff !important; }
        .theme-dark .legend-title, .theme-dark .sidebar-content h5, .theme-dark .form-group label { color: #ffffff !important; }
        /* Muted/success/error notes adapt to theme */
        .muted-note { color: var(--muted-color); }
        .spatial-note { color: var(--accent-4); font-weight: 600; }
        .error-note { color: var(--error-color); background: rgba(231,76,60,0.06); }
        .success-note { color: var(--success-color); }
        .theme-dark .muted-note { color: rgba(255,255,255,0.82); }
        .theme-dark .error-note { color: #ffb3b3; background: rgba(255, 30, 30, 0.08); }
        .theme-dark .success-note { color: #8cf5b2; }
        .theme-dark .btn-primary, .theme-dark .btn { color: #ffffff !important; background: linear-gradient(90deg,var(--accent-4),var(--accent-3)) !important; border: none !important; }
        .theme-dark input, .theme-dark select, .theme-dark textarea { background: rgba(255,255,255,0.02) !important; color: #ffffff !important; border: 1px solid rgba(255,255,255,0.06) !important; }
        .theme-dark .legend-swatch { border-color: rgba(255,255,255,0.04) !important; }
        /* Additional dark-mode text overrides for elements with inline blue color */
        .theme-dark .nav-link, .theme-dark .navbar-brand, .theme-dark .navbar-nav .nav-link { color: #ffffff !important; }
        .theme-dark #legend-control, .theme-dark #legend-control * { color: #ffffff !important; }
        .theme-dark #basemaps-control, .theme-dark #basemaps-control * { color: #ffffff !important; }
        .theme-dark #layers-control h6, .theme-dark #layers-control label, .theme-dark #layers-control span { color: #ffffff !important; }
        .theme-dark .result-item, .theme-dark .result-item h5, .theme-dark .result-item span { color: #ffffff !important; }
        /* Catch inline styled color occurrences if present */
        .theme-dark [style*="color: #1e3c72"], .theme-dark [style*="color:#1e3c72"] { color: #ffffff !important; }
        .theme-dark a, .theme-dark a:hover, .theme-dark a:focus { color: #ffffff !important; }
        .theme-dark .form-group p, .theme-dark .query-results { color: #ffffff !important; }

        /* Ensure map control icons respect theme (zoom, locate, search, measure) */
        .theme-claire .leaflet-control-zoom-in,
        .theme-claire .leaflet-control-zoom-out,
        .theme-claire .leaflet-control-locate a,
        .theme-claire .leaflet-touch .leaflet-control-geocoder-icon,
        .theme-claire .leaflet-control-search .search-button,
        .theme-claire .leaflet-control-measure {
            background: var(--control-bg) !important;
            color: var(--text-color) !important;
            border-radius: 4px !important;
        }
        .theme-claire .leaflet-control-locate.active a { color: var(--accent-4) !important; }
        .theme-claire .leaflet-control-locate.active.following a { color: var(--accent-3) !important; }

        .theme-dark .leaflet-control-zoom-in,
        .theme-dark .leaflet-control-zoom-out,
        .theme-dark .leaflet-control-locate a,
        .theme-dark .leaflet-touch .leaflet-control-geocoder-icon,
        .theme-dark .leaflet-control-search .search-button,
        .theme-dark .leaflet-control-measure {
            background: rgba(255,255,255,0.02) !important;
            color: var(--text-color) !important;
            border-radius: 4px !important;
            border: 1px solid rgba(255,255,255,0.04) !important;
        }
        .theme-dark .leaflet-control-locate.active a { color: var(--accent-4) !important; }
        .theme-dark .leaflet-control-locate.active.following a { color: var(--accent-3) !important; }

        /* Force icons inside leaflet controls to inherit their text color */
        .leaflet-control .fa, .leaflet-control a .fa { color: inherit !important; fill: none !important; }

        /* Theme: Solar - warm golden tones */
        .theme-solar {
            --control-bg: linear-gradient(180deg, rgba(255,250,235,0.96), rgba(255,245,230,0.94));
            --accent-1: #ff9e40; /* amber */
            --accent-2: #ffd166; /* light gold */
            --accent-3: #ff6b35; /* terracotta */
            --accent-4: #3b82c4; /* azure */
            --accent-5: #b3884a;
            --text-color: #2b2b21;
            background: linear-gradient(180deg,#fff9e6,#fff6dc);
            color: var(--text-color);
        }
        .theme-solar .leaflet-tooltip.css_Region_1 { background: linear-gradient(90deg,#fff7e0,#fff2cc); color: #2b2b21; border-color: rgba(0,0,0,0.04); }

        /* Theme: Pastel - soft and airy */
        .theme-pastel {
            --control-bg: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(246,255,253,0.98));
            --accent-1: #a8e6cf;
            --accent-2: #ffd1dc;
            --accent-3: #c5d7ff;
            --accent-4: #b8e1ff;
            --accent-5: #d4b5ff;
            --text-color: #274156;
            background: linear-gradient(180deg,#f3fff7,#ffffff);
            color: var(--text-color);
        }
        .theme-pastel .leaflet-tooltip.css_Region_1 { background: rgba(255,255,255,0.98); color: var(--text-color); border-color: rgba(0,0,0,0.03); }

        /* Theme: Monochrome - neutral high-contrast */
        .theme-mono {
            --control-bg: linear-gradient(180deg, rgba(245,246,248,0.98), rgba(237,239,241,0.98));
            --accent-1: #37474f;
            --accent-2: #90a4ae;
            --accent-3: #b0bec5;
            --accent-4: #78909c;
            --accent-5: #cfd8dc;
            --text-color: #0f1720;
            background: #f7f9fa;
            color: var(--text-color);
        }
        .theme-mono .leaflet-tooltip.css_Region_1 { background: linear-gradient(90deg,#ffffff,#f7f7f7); color: #222; }

        /* Theme-specific cluster color overrides */
        .theme-claire .marker-cluster-small { background: linear-gradient(135deg,#ff9f43,#ffd166); color: #111; }
        .theme-claire .marker-cluster-medium { background: linear-gradient(135deg,#ffd166,#ffcc66); color: #111; }
        .theme-claire .marker-cluster-large { background: linear-gradient(135deg,#ff6b6b,#ff3b3b); color: #fff; }

        .theme-dark .marker-cluster-small { background: linear-gradient(135deg,#3b6fff,#00e6b8); color: #001; }
        .theme-dark .marker-cluster-medium { background: linear-gradient(135deg,#5bb0ff,#c085ff); color: #fff; }
        .theme-dark .marker-cluster-large { background: radial-gradient(circle at 30% 30%, #ff6b6b 0%, #9b2a2a 60%); color: #fff; }

        .theme-solar .marker-cluster-small { background: linear-gradient(135deg,#ffd166,#ff9f43); color: #222; }
        .theme-solar .marker-cluster-medium { background: linear-gradient(135deg,#ffb74d,#ff8a3d); color: #111; }
        .theme-solar .marker-cluster-large { background: linear-gradient(135deg,#ff7043,#b24b2b); color: #fff; }

        .theme-pastel .marker-cluster-small { background: linear-gradient(135deg,#a8e6cf,#ffd1dc); color: #233044; }
        .theme-pastel .marker-cluster-medium { background: linear-gradient(135deg,#c5d7ff,#b8e1ff); color: #233044; }
        .theme-pastel .marker-cluster-large { background: linear-gradient(135deg,#d4b5ff,#cbb3ff); color: #fff; }

        .theme-mono .marker-cluster-small { background: linear-gradient(135deg,#90a4ae,#b0bec5); color: #111; }
        .theme-mono .marker-cluster-medium { background: linear-gradient(135deg,#78909c,#90a4ae); color: #111; }
        .theme-mono .marker-cluster-large { background: radial-gradient(circle at 30% 30%, #37474f 0%, #222 80%); color: #fff; }

        /* Swatch display used in the theme picker */
        .swatch { display:inline-block; width:16px; height:12px; border-radius:4px; margin-right:8px; border: 1px solid rgba(0,0,0,0.06); vertical-align:middle; }

        /* Smooth transitions when switching theme */
        html { transition: background 320ms ease, color 320ms ease; }
        .leaflet-container { transition: filter 320ms ease; }

        /* Ensure controls inherit accent colors */
        .btn-primary { background: linear-gradient(90deg,var(--accent-4),var(--accent-3)); color: white; }
        .legend-title { color: var(--accent-4); }
        .sidebar { border-color: rgba(0,0,0,0.04); }
        .theme-dark .sidebar { border-color: rgba(255,255,255,0.03) !important; }
        .theme-dark .sidebar, .theme-dark .leaflet-control, .theme-dark .control-card {
            background: rgba(8,12,20,0.9) !important;
            color: var(--text-color) !important;
            border-color: rgba(255,255,255,0.03) !important;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5) !important;
        }
        .theme-dark .sidebar-content h5, .theme-dark .legend-title { color: var(--accent-4) !important; }
        .theme-dark .leaflet-tooltip.css_Region_1 { background: linear-gradient(90deg, rgba(8,12,20,0.92), rgba(8,12,20,0.76)) !important; color: var(--text-color) !important; border-color: rgba(255,255,255,0.03) !important; }

        /* Animations are opt-in via the .animations-enabled class on the root */
        .animations-enabled .marker-cluster { animation: popIn 520ms cubic-bezier(.2,.9,.3,1) both; }
        .animations-enabled .marker-cluster:hover { transform: translateY(-6px) scale(1.06); transition: transform 160ms ease; }
        @keyframes popIn { 0% { transform: scale(.22); opacity: 0; } 60% { transform: scale(1.06); opacity: 1; } 100% { transform: scale(1); } }

        .animations-enabled .region-highlight.glow { filter: drop-shadow(0 0 10px rgba(255,107,107,0.9)); transition: filter 140ms ease; }
        .animations-enabled .localite-marker.leaflet-interactive { transition: transform 120ms ease, filter 120ms ease; }
        .animations-enabled .localite-marker.leaflet-interactive:hover { transform: scale(1.14); filter: drop-shadow(0 6px 12px rgba(0,0,0,0.3)); }

        /* small pulse for important clusters */
        .animations-enabled .marker-cluster-xlarge { animation: pulse 2s ease-out infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,59,59,0.33);} 70% { box-shadow: 0 0 0 24px rgba(255,59,59,0); } 100% { box-shadow: 0 0 0 0 rgba(255,59,59,0); } }
        /* Region hover highlight */
        .region-highlight {
            transition: fill-opacity 220ms ease, stroke-width 160ms ease, filter 220ms ease;
            filter: drop-shadow(0 6px 18px rgba(0,0,0,0.12));
        }
        /* Legend enhancements */
        .legend-swatch { width: 28px; height: 16px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.06); display:inline-block; margin-right:8px; }
        .legend-title { color: #0b2447; font-weight:700; margin-bottom:6px; }
        .btn-primary { background: linear-gradient(90deg,var(--accent-4),var(--accent-3)); border: none; }
        .btn-outline-primary { border-color: rgba(13,110,253,0.12); }
        .control-card { background: var(--control-bg); padding: 10px; border-radius:8px; box-shadow: 0 6px 16px rgba(10,20,40,0.06); }

        .sidebar-content h6 {
            margin-top: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .sidebar-content h5:first-child {
            margin-top: 0;
        }
        .sidebar-content h5 i {
            margin-right: 8px;
            color: #667eea;
        }
        .coordinates {
            position: absolute;
            bottom: 20px;
            left: 300px;
            background: linear-gradient(135deg, rgba(30, 60, 114, 0.95) 0%, rgba(42, 82, 152, 0.95) 100%);
            color: #00d4ff;
            padding: 12px 18px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
            font-weight: 600;
        }
        .minimap-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .leaflet-control-scale {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(245, 247, 250, 0.9) 100%);
            border: 2px solid #667eea;
            border-radius: 6px;
        }
        .leaflet-control-layers {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 247, 250, 0.95) 100%);
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .leaflet-control-layers-list label {
            color: var(--text-color);
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .leaflet-control-layers-list label:hover {
            color: #667eea;
            transform: translateX(4px);
        }
        .leaflet-control-layers-list input {
            accent-color: #667eea;
        }
        #basemaps-control {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e0e7ff;
            margin-bottom: 15px;
        }
        #basemaps-control label {
            color: var(--text-color);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            margin-bottom: 6px;
        }
        #basemaps-control label:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateX(4px);
        }
        #basemaps-control input {
            accent-color: #667eea;
            margin-right: 10px;
            cursor: pointer;
        }
        #legend-control {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e0e7ff;
        }
        #legend-control h6 {
            color: #667eea;
            font-weight: 700;
            margin-top: 12px;
            margin-bottom: 8px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
        }
        #legend-control h6 i {
            margin-right: 6px;
        }
        #legend-control > div > div {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
            color: var(--text-color);
            font-size: 0.95rem;
            font-weight: 500;
        }
        #legend-control > div > div:hover {
            background: rgba(102, 126, 234, 0.15);
            transform: translateX(2px);
        }
        .toggle-panel-btn {
            display: none;
        }
        .sidebar-content::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar-content::-webkit-scrollbar-track {
            background: rgba(102, 126, 234, 0.08);
            border-radius: 4px;
        }
        .sidebar-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #764ba2 0%, #667eea 100%);
        }
        @keyframes slideIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .sidebar-content > * {
            animation: slideIn 0.2s ease-out;
        }
        
        /* Modal pour les requêtes */
        .query-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .query-modal-content {
            background: linear-gradient(180deg, #ffffff 0%, #f5f7fa 100%);
            margin: 5% auto;
            padding: 30px;
            border: 2px solid #667eea;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        .query-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        .query-modal-header h3 {
            color: #1e3c72;
            margin: 0;
            font-weight: 700;
        }
        .close-modal {
            color: #e74c3c;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .close-modal:hover {
            color: #c0392b;
            transform: scale(1.2);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #1e3c72;
            font-weight: 600;
        }
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e7ff;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn-query {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        .btn-query:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .query-results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        .query-results h4 {
            color: #1e3c72;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .result-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .result-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .query-modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        </style>
        <title>Cartographie web des limites administratives du Sénégal</title>
        <!-- PWA: manifest & icons -->
        <link rel="manifest" href="/manifest.json">
        <meta name="theme-color" content="#667eea">
        <link rel="icon" href="images/icons/icon-192.svg" sizes="192x192" type="image/svg+xml">
        <link rel="apple-touch-icon" href="images/icons/apple-touch-icon.svg">
    </head>
    <body>
        <!-- Barre de navigation -->
        <nav id="navbar" class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><i class="fas fa-globe"></i> SIG Sénégal</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" id="home"><i class="fas fa-home"></i> Accueil</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="about"><i class="fas fa-info-circle"></i> À propos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="catalog"><i class="fas fa-database"></i> Catalogue</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="spatial-query"><i class="fas fa-map-pin"></i> Requête spatiale</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="attribute-query"><i class="fas fa-filter"></i> Requête attributaire</a>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="toolsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-tools"></i> Outils
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="toolsDropdown">
                                <li><a class="dropdown-item" href="#" id="download-csv"><i class="fas fa-file-csv"></i> Télécharger CSV</a></li>
                                <li><a class="dropdown-item" href="#" id="download-geojson"><i class="fas fa-file-json"></i> Télécharger GeoJSON</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="measure"><i class="fas fa-ruler"></i> Mesure</a></li>
                                <li><a class="dropdown-item" href="#" id="zoom-in"><i class="fas fa-search-plus"></i> Zoom avant</a></li>
                                <li><a class="dropdown-item" href="#" id="zoom-out"><i class="fas fa-search-minus"></i> Zoom arrière</a></li>
                                <li><a class="dropdown-item" href="#" id="home-view"><i class="fas fa-home"></i> Vue initiale</a></li>
                                <li><a class="dropdown-item" href="#" id="print"><i class="fas fa-print"></i> Impression</a></li>
                                <li><a class="dropdown-item" href="#" id="search"><i class="fas fa-search"></i> Recherche rapide</a></li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="geolocate-btn" title="Localiser"><i class="fas fa-location-crosshairs"></i></a>
                        </li>
                        <li class="nav-item" id="install-li" style="display:none;">
                            <a class="nav-link" href="#" id="install-btn" title="Installer l'application"><i class="fas fa-download"></i></a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link" href="#" id="themeDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" title="Changer le thème">
                                <i class="fas fa-palette"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="themeDropdown" style="min-width:210px;">
                                <li><a class="dropdown-item theme-select" href="#" data-theme="claire"><span class="swatch" style="background:#ffffff; border:1px solid rgba(0,0,0,0.06)"></span> Claire</a></li>
                                <li><a class="dropdown-item theme-select" href="#" data-theme="dark"><span class="swatch" style="background:#071022"></span> Sombre</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="theme-cycle"><i class="fas fa-sync-alt"></i> Basculer</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Modal À propos -->
        <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="aboutModalLabel"><i class="fas fa-info-circle"></i> À propos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
              </div>
              <div class="modal-body">
                <p><strong><u><i class="fas fa-user"></i> Auteur :</u></strong> Mouhsine Abdallah Babacar DIAO</p>
                <p><strong><u><i class="fas fa-phone"></i> Téléphone :</u></strong> +221778379457</p>
                <p><strong><u><i class="fas fa-envelope"></i> Email :</u></strong> <a href="mailto:mouhsineabdallahbabacar@gmail.com">mouhsineabdallahbabacar@gmail.com</a>, <a href="mailto:diao.mouhsine@uam.edu.sn">diao.mouhsine@uam.edu.sn</a></p>
                <p><strong><u><i class="fas fa-book"></i> Description :</u></strong> La cartographie web (Systèmes d'Information Géographique - SIG) permet de visualiser, analyser et partager des informations géographiques via un navigateur. Cette application illustre des outils SIG modernes (couches vectorielles, requêtes spatiales et attributaires, clustering, mesures et export) pour faciliter l'exploration interactive et l'aide à la décision territoriale.</p>
                <p><strong><u><i class="fas fa-cogs"></i> Fonctionnalités :</u></strong></p>
                <ul>
                  <li><i class="fas fa-map-marker-alt"></i> Requêtes spatiales interactives</li>
                  <li><i class="fas fa-filter"></i> Requêtes attributaires avancées</li>
                  <li><i class="fas fa-layer-group"></i> Affichage multicouches</li>
                  <li><i class="fas fa-ruler"></i> Outils de mesure</li>
                  <li><i class="fas fa-search"></i> Recherche rapide</li>
                </ul>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal pour Requête Spatiale -->
        <div id="spatial-modal" class="query-modal">
            <div class="query-modal-content">
                <div class="query-modal-header">
                    <h3><i class="fas fa-map-pin"></i> Requête Spatiale</h3>
                    <span class="close-modal" data-modal="spatial-modal">&times;</span>
                </div>
                <div class="form-group">
                    <label>Type de couche :</label>
                    <select id="spatial-layer-type">
                        <option value="region">Régions</option>
                        <option value="departement">Départements</option>
                        <option value="arrondissement">Arrondissements</option>
                        <option value="routes">Routes</option>
                        <option value="localite">Localités</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Instruction :</label>
                    <p class="muted-note" style="font-size: 14px;">Cliquez sur un élément de la carte pour voir ses informations détaillées et ses relations spatiales.</p>
                </div>
                <button class="btn-query" onclick="enableSpatialQuery()">Activer la requête spatiale</button>
                <div id="spatial-results" class="query-results" style="display: none;"></div>
            </div>
        </div>

        <!-- Modal pour Requête Attributaire -->
        <div id="attribute-modal" class="query-modal">
            <div class="query-modal-content">
                <div class="query-modal-header">
                    <h3><i class="fas fa-filter"></i> Requête Attributaire</h3>
                    <span class="close-modal" data-modal="attribute-modal">&times;</span>
                </div>
                <div class="form-group">
                    <label>Couche :</label>
                    <select id="attribute-layer" onchange="updateAttributeFields()">
                        <option value="region">Régions</option>
                        <option value="departement">Départements</option>
                        <option value="arrondissement">Arrondissements</option>
                        <option value="routes">Routes</option>
                        <option value="localite">Localités</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Attribut :</label>
                    <select id="attribute-field">
                        <option value="Région">Région</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Opérateur :</label>
                    <select id="attribute-operator">
                        <option value="equals">Égal à</option>
                        <option value="contains">Contient</option>
                        <option value="greater">Supérieur à</option>
                        <option value="less">Inférieur à</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valeur :</label>
                    <input type="text" id="attribute-value" placeholder="Entrez une valeur">
                </div>
                <button class="btn-query" onclick="executeAttributeQuery()">Exécuter la requête</button>
                <div id="attribute-results" class="query-results" style="display: none;"></div>
            </div>
        </div>

        <!-- Panneau gauche : Contrôle des couches -->
        <div id="layers-panel" class="sidebar left">
            <div class="sidebar-content">
                <h5><i class="fas fa-layer-group"></i> Contrôle des couches</h5>
                <div id="layers-control"></div>
            </div>
        </div>

        <!-- Panneau droit : Basemaps et Légende -->
        <div id="basemaps-panel" class="sidebar right">
            <div class="sidebar-content">
                <h5><i class="fas fa-map"></i> Basemaps</h5>
                <div id="basemaps-control"></div>
                <h5><i class="fas fa-bookmark"></i> Légende</h5>
                <div id="legend-control"></div>
            </div>
        </div>

        <!-- Carte -->
        <div id="map"></div>

        <!-- Coordonnées -->
        <div id="coordinates" class="coordinates">Lat: 0.0000, Lng: 0.0000</div>

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/leaflet.markercluster.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="https://unpkg.com/leaflet-minimap@3.6.1/dist/Control.MiniMap.min.js"></script>
        <script src="data/Region_1.js"></script>
        <script src="data/Departement_2.js"></script>
        <script src="data/Arrondissement_3.js"></script>
        <script src="data/Routes_4.js"></script>
        <script src="data/localites_5.js"></script>
        <script>
        var highlightLayer;
        var spatialQueryActive = false;
        var currentQueryLayerType = 'region';
        
        function highlightFeature(e) {
            highlightLayer = e.target;

            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: 'rgba(255, 255, 0, 1.00)',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: 'rgba(255, 255, 0, 1.00)',
                fillOpacity: 1
              });
            }
            highlightLayer.openPopup();
        }
        
        var map = L.map('map', {
            zoomControl:false, maxZoom:20, minZoom:1
        }).setView([14.4974, -14.4524], 7);
        
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }

        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }

        var bounds_group = new L.featureGroup([]);
        function setBounds() {
            if (bounds_group.getLayers().length) {
                map.fitBounds(bounds_group.getBounds());
            }
        }
        
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 20,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OpenStreetMap_0;
        map.addLayer(layer_OpenStreetMap_0);

        // Contrôles
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        
        L.control.locate({locateOptions: {maxZoom: 19}}).addTo(map);
        
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';

        // Échelle
        L.control.scale().addTo(map);

        // Mini map
        var osmUrl = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';
        var osmAttrib = 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
        var osm = new L.TileLayer(osmUrl, {minZoom: 0, maxZoom: 13, attribution: osmAttrib});
        var miniMap = new L.Control.MiniMap(osm, { toggleDisplay: true }).addTo(map);

        // Coordonnées dynamiques
        map.on('mousemove', function(e) {
            document.getElementById('coordinates').innerHTML = 'Lat: ' + e.latlng.lat.toFixed(4) + ', Lng: ' + e.latlng.lng.toFixed(4);
        });

        // Définir les variables de couches
        var layer_Region_1, layer_Departement_2, layer_Arrondissement_3, layer_Routes_4, layer_localites_5, cluster_localites_5;

        // Basemaps
        var basemaps = {
            "OpenStreetMap": layer_OpenStreetMap_0,
            "Sombre": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
                subdomains: ['a','b','c','d'],
                maxZoom: 19,
                attribution: 'Map tiles © <a href="https://carto.com/">CARTO</a> &mdash; © OpenStreetMap contributors'
            }),
            "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri'
            })
        };

        // Couches overlays
        var overlays = {};

        // Région
        function pop_Region_1(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    // Remove glow class used for animations (if present)
                    try {
                        if (e.target && e.target._path && e.target._path.classList) {
                            e.target._path.classList.remove('glow');
                        }
                    } catch (err) {}
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    }
                },
                mouseover: highlightFeature,
                click: function(e) {
                    if (spatialQueryActive && currentQueryLayerType === 'region') {
                        showSpatialResult(feature, 'Région');
                    }
                }
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Région</th>\
                        <td>' + (feature.properties['Région'] != null ? autolinker.link(feature.properties['Région'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }
        
        // Color helper -> deterministic color per region name
        function getColorForRegion(name) {
            var palette = ['#ff6b6b','#ffd166','#6bcB77','#4da6ff','#9b59b6','#ff7f50','#00c0a3','#ffcc00','#ff3b3b','#7bd389'];
            if (!name) return palette[0];
            var s = 0; for (var i=0;i<name.length;i++) s += name.charCodeAt(i);
            return palette[s % palette.length];
        }
        function style_Region_1_0(feature) {
            var name = feature && feature.properties && feature.properties['Région'] ? feature.properties['Région'] : '';
            var c = getColorForRegion(name);
            return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.85)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.25,
                fill: true,
                fillOpacity: 0.75,
                fillColor: c,
                interactive: true,
                className: 'region-highlight'
            };
        }
        
        map.createPane('pane_Region_1');
        map.getPane('pane_Region_1').style.zIndex = 401;
        var layer_Region_1 = new L.geoJson(json_Region_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Region_1',
            layerName: 'layer_Region_1',
            pane: 'pane_Region_1',
            onEachFeature: pop_Region_1,
            style: style_Region_1_0,
        });
        bounds_group.addLayer(layer_Region_1);
        
        var cluster_localites_5 = L.markerClusterGroup({});

        // Départements
        function pop_Departement_2(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    // Remove glow class used for animations (if present)
                    try {
                        if (e.target && e.target._path && e.target._path.classList) {
                            e.target._path.classList.remove('glow');
                        }
                    } catch (err) {}
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    }
                },
                mouseover: highlightFeature,
                click: function(e) {
                    if (spatialQueryActive && currentQueryLayerType === 'departement') {
                        showSpatialResult(feature, 'Département');
                    }
                }
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Département</th>\
                        <td>' + (feature.properties['Département'] != null ? autolinker.link(feature.properties['Département'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Région</th>\
                        <td>' + (feature.properties['Région'] != null ? autolinker.link(feature.properties['Région'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }
        
        function style_Departement_2_0() {
            return {
                pane: 'pane_Departement_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(255,255,255,0.0)',
                interactive: true,
            }
        }
        
        map.createPane('pane_Departement_2');
        map.getPane('pane_Departement_2').style.zIndex = 402;
        var layer_Departement_2 = new L.geoJson(json_Departement_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Departement_2',
            layerName: 'layer_Departement_2',
            pane: 'pane_Departement_2',
            onEachFeature: pop_Departement_2,
            style: style_Departement_2_0,
        });
        bounds_group.addLayer(layer_Departement_2);

        // Arrondissements
        function pop_Arrondissement_3(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    // Remove glow class used for animations (if present)
                    try {
                        if (e.target && e.target._path && e.target._path.classList) {
                            e.target._path.classList.remove('glow');
                        }
                    } catch (err) {}
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    }
                },
                mouseover: highlightFeature,
                click: function(e) {
                    if (spatialQueryActive && currentQueryLayerType === 'arrondissement') {
                        showSpatialResult(feature, 'Arrondissement');
                    }
                }
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Arrondissement</th>\
                        <td>' + (feature.properties['Arrondissement'] != null ? autolinker.link(feature.properties['Arrondissement'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Département</th>\
                        <td>' + (feature.properties['Département'] != null ? autolinker.link(feature.properties['Département'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Région</th>\
                        <td>' + (feature.properties['Région'] != null ? autolinker.link(feature.properties['Région'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }
        
        function style_Arrondissement_3_0() {
            return {
                pane: 'pane_Arrondissement_3',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(255,255,255,0.0)',
                interactive: true,
            }
        }
        
        map.createPane('pane_Arrondissement_3');
        map.getPane('pane_Arrondissement_3').style.zIndex = 403;
        var layer_Arrondissement_3 = new L.geoJson(json_Arrondissement_3, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Arrondissement_3',
            layerName: 'layer_Arrondissement_3',
            pane: 'pane_Arrondissement_3',
            onEachFeature: pop_Arrondissement_3,
            style: style_Arrondissement_3_0,
        });
        bounds_group.addLayer(layer_Arrondissement_3);

        // Routes
        function pop_Routes_4(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    // Remove glow class used for animations (if present)
                    try {
                        if (e.target && e.target._path && e.target._path.classList) {
                            e.target._path.classList.remove('glow');
                        }
                    } catch (err) {}
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    }
                },
                mouseover: highlightFeature,
                click: function(e) {
                    if (spatialQueryActive && currentQueryLayerType === 'routes') {
                        showSpatialResult(feature, 'Route');
                    }
                }
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Type</th>\
                        <td>' + (feature.properties['Type'] != null ? autolinker.link(feature.properties['Type'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }
        
        function style_Routes_4_0(feature) {
            if (feature.properties['Type'] >= 0.000000 && feature.properties['Type'] <= 0.000000) {
                return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: true,
            }
            }
            if (feature.properties['Type'] >= 1.000000 && feature.properties['Type'] <= 1.000000) {
                return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: true,
            }
            }
            if (feature.properties['Type'] >= 2.000000 && feature.properties['Type'] <= 2.000000) {
                return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: true,
            }
            }
            if (feature.properties['Type'] >= 3.000000 && feature.properties['Type'] <= 3.000000) {
                return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: true,
            }
            }
            if (feature.properties['Type'] >= 4.000000 && feature.properties['Type'] <= 4.000000) {
                return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: true,
            }
            }
            if (feature.properties['Type'] >= 5.000000 && feature.properties['Type'] <= 5.000000) {
                return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: true,
            }
            }
            if (feature.properties['Type'] >= 6.000000 && feature.properties['Type'] <= 6.000000) {
                return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: true,
            }
            }
            if (feature.properties['Type'] >= 7.000000 && feature.properties['Type'] <= 7.000000) {
                return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: true,
            }
            }
            if (feature.properties['Type'] >= 8.000000 && feature.properties['Type'] <= 8.000000) {
                return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: true,
            }
            }
            if (feature.properties['Type'] >= 9.000000 && feature.properties['Type'] <= 9.000000) {
                return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: true,
            }
            }
        }
        
        map.createPane('pane_Routes_4');
        map.getPane('pane_Routes_4').style.zIndex = 404;
        var layer_Routes_4 = new L.geoJson(json_Routes_4, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Routes_4',
            layerName: 'layer_Routes_4',
            pane: 'pane_Routes_4',
            onEachFeature: pop_Routes_4,
            style: style_Routes_4_0,
        });
        bounds_group.addLayer(layer_Routes_4);

        // Localités
        function pop_localites_5(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    // Remove glow class used for animations (if present)
                    try {
                        if (e.target && e.target._path && e.target._path.classList) {
                            e.target._path.classList.remove('glow');
                        }
                    } catch (err) {}
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    }
                },
                mouseover: highlightFeature,
                click: function(e) {
                    if (spatialQueryActive && currentQueryLayerType === 'localite') {
                        showSpatialResult(feature, 'Localité');
                    }
                }
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">NOM</th>\
                        <td>' + (feature.properties['NOM'] != null ? autolinker.link(feature.properties['NOM'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">TYPE</th>\
                        <td>' + (feature.properties['TYPE'] != null ? autolinker.link(feature.properties['TYPE'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">POPULATION</th>\
                        <td>' + (feature.properties['POPULATION'] != null ? autolinker.link(feature.properties['POPULATION'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">DEPARTEMENT</th>\
                        <td>' + (feature.properties['DEPARTEMENT'] != null ? autolinker.link(feature.properties['DEPARTEMENT'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">REGION</th>\
                        <td>' + (feature.properties['REGION'] != null ? autolinker.link(feature.properties['REGION'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }
        
        function getColorForValue(v) {
            if (v === null || typeof v === 'undefined' || isNaN(Number(v))) return '#4daf4a';
            v = Number(v);
            if (v > 1000) return '#c70039';
            if (v > 500) return '#ff6b6b';
            if (v > 200) return '#ff9f43';
            if (v > 50) return '#ffd166';
            return '#4daf4a';
        }
        function style_localites_5_0(feature) {
            var val = feature && feature.properties ? (feature.properties['NUM_VILLAG'] || feature.properties['POP'] || feature.properties['NUM'] ) : null;
            var color = getColorForValue(val);
            return {
                pane: 'pane_localites_5',
                radius: 6 + (val && !isNaN(Number(val)) ? Math.min(8, Math.log(Number(val)+1)) : 0),
                opacity: 1,
                color: '#222',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 0.95,
                fillColor: color,
                interactive: true,
            };
        }
        
        map.createPane('pane_localites_5');
        map.getPane('pane_localites_5').style.zIndex = 405;
        var layer_localites_5 = new L.geoJson(json_localites_5, {
            attribution: '',
            interactive: true,
            dataVar: 'json_localites_5',
            layerName: 'layer_localites_5',
            pane: 'pane_localites_5',
            onEachFeature: pop_localites_5,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                // use circle markers styled by property value
                return L.circleMarker(latlng, style_localites_5_0(feature));
            },
        });
        bounds_group.addLayer(layer_localites_5);
        cluster_localites_5.addLayer(layer_localites_5);

        // Appliquer les styles et popups
        layer_Region_1.eachLayer(function(layer) {
            layer_Region_1.resetStyle(layer);
            pop_Region_1(layer.feature, layer);
        });
        layer_Departement_2.eachLayer(function(layer) {
            layer_Departement_2.resetStyle(layer);
            pop_Departement_2(layer.feature, layer);
        });
        layer_Arrondissement_3.eachLayer(function(layer) {
            layer_Arrondissement_3.resetStyle(layer);
            pop_Arrondissement_3(layer.feature, layer);
        });
        layer_Routes_4.eachLayer(function(layer) {
            layer_Routes_4.resetStyle(layer);
            pop_Routes_4(layer.feature, layer);
        });

        // Recherche
        map.addControl(new L.Control.Search({
            layer: cluster_localites_5,
            initial: false,
            hideMarkerOnCollapse: true,
            propertyName: 'NOM'}));
        if (typeof url === 'undefined') {
            document.getElementsByClassName('search-button')[0].className += ' fa fa-binoculars';
        } else {
            document.getElementsByClassName('search-button')[1].className += ' fa fa-binoculars';
        }

        // Labels
        var labels = [];
        var totalMarkers = 0;
        layer_Region_1.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Région'] != null?String('<div class="tooltip-text tooltip-region">' + layer.feature.properties['Région']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Region_1'});
            labels.push(layer);
            totalMarkers += 1;
            layer.added = true;
        });
        layer_localites_5.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['NOM'] != null?String('<div class="tooltip-text tooltip-localite">' + layer.feature.properties['NOM']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_localites_5'});
            labels.push(layer);
            totalMarkers += 1;
            layer.added = true;
        });

        function resetLabels(layers) {
            map.off("layeradd", resetLabelsHandler);
            map.off("layerremove", resetLabelsHandler);
            
            for (var i = 0; i < layers.length; i++) {
                var layer = layers[i];
                layer.eachLayer(function(marker) {
                    if (marker.getTooltip() && marker.getTooltip().getContent() && marker.added) {
                        marker.closeTooltip();
                        marker.openTooltip();
                    }
                });
            }
            
            map.on("layeradd", resetLabelsHandler);
            map.on("layerremove", resetLabelsHandler);
        }
        
        function resetLabelsHandler() {
            resetLabels([layer_Region_1, layer_localites_5]);
        }
        
        resetLabels([layer_Region_1, layer_localites_5]);
        map.on("zoomend", function(){
            resetLabels([layer_Region_1, layer_localites_5]);
        });
        map.on("layeradd", resetLabelsHandler);
        map.on("layerremove", resetLabelsHandler);

        // Ajouter les couches à la carte
        map.addLayer(layer_Region_1);
        map.addLayer(cluster_localites_5);

        // Créer la légende
        var legendHtml = '<div>';
        // Regions palette
        legendHtml += '<div class="control-card" style="margin-bottom:10px">';
        legendHtml += '<div class="legend-title"><i class="fas fa-border-all"></i> Régions</div>';
        var sampleColors = ['#ff6b6b','#ffd166','#6bcB77','#4da6ff','#9b59b6','#ff7f50'];
        legendHtml += '<div style="display:flex; gap:8px; flex-wrap:wrap;">';
        for (var si=0; si<sampleColors.length; si++) { legendHtml += '<span class="legend-swatch" style="background:'+sampleColors[si]+'"></span>'; }
        legendHtml += '</div>';
        legendHtml += '<div class="legend-note" style="margin-top:8px;">Couleurs par région</div>'; 
        legendHtml += '</div>';
        // Overlays short descriptions
        legendHtml += '<div class="control-card" style="margin-bottom:10px">';
        legendHtml += '<div class="legend-title"><i class="fas fa-map-signs"></i> Départements / Arrondissements</div>';
        legendHtml += '<div class="legend-note">Limites administratives</div>'; 
        legendHtml += '</div>';
        // Routes
        legendHtml += '<div class="control-card" style="margin-bottom:10px">';
        legendHtml += '<div class="legend-title"><i class="fas fa-road"></i> Routes</div>';
        legendHtml += '<div class="legend-note">Classification routière</div>'; 
        legendHtml += '</div>';
        // Localities density ramp
        legendHtml += '<div class="control-card">';
        legendHtml += '<div class="legend-title"><i class="fas fa-map-pin"></i> Localités (densité)</div>';
        legendHtml += '<div style="display:flex; align-items:center; gap:8px; margin-top:6px">';
        legendHtml += '<span style="display:inline-block; width:18px; height:12px; background:#4daf4a; border-radius:4px"></span><span style="font-weight:500;">Faible</span>';
        legendHtml += '<span style="display:inline-block; width:18px; height:12px; background:#ffd166; border-radius:4px; margin-left:8px"></span><span style="font-weight:500;">Modéré</span>';
        legendHtml += '<span style="display:inline-block; width:18px; height:12px; background:#ff9f43; border-radius:4px; margin-left:8px"></span><span style="font-weight:500;">Élevé</span>';
        legendHtml += '<span style="display:inline-block; width:18px; height:12px; background:#c70039; border-radius:4px; margin-left:8px"></span><span style="font-weight:500;">Très élevé</span>';
        legendHtml += '</div>';
        legendHtml += '</div>';
        legendHtml += '</div>';
        document.getElementById('legend-control').innerHTML = legendHtml;

        // Basemaps control
        var basemapsHtml = '<div>';
        var basemapIndex = 0;
        var basemapColors = ['#3498db', '#e74c3c', '#111111'];
        var basemapIcons = ['fas fa-map', 'fas fa-satellite', 'fas fa-moon'];
        for (var name in basemaps) {
            var bgColor = basemapColors[basemapIndex] || '#667eea';
            var icon = basemapIcons[basemapIndex] || 'fas fa-globe';
            basemapsHtml += '<label style="cursor: pointer; display: flex; align-items: center; padding: 12px; background: linear-gradient(135deg, rgba(' + 
                            (basemapIndex === 0 ? '52, 152, 219' : '231, 76, 60') + ', 0.08) 0%, rgba(' + 
                            (basemapIndex === 0 ? '41, 128, 185' : '192, 57, 43') + ', 0.08) 100%); border-radius: 8px; margin-bottom: 10px; border: 2px solid ' + 
                            (basemapIndex === 0 ? '#d6eaf8' : '#fadbd8') + '; transition: all 0.3s ease;">';
            basemapsHtml += '<input type="radio" name="basemap" value="' + name + '" style="margin-right: 12px; accent-color: ' + bgColor + '; cursor: pointer;" ' + 
                           (name === 'OpenStreetMap' ? 'checked' : '') + '>';
            basemapsHtml += '<i class="' + icon + '" style="margin-right: 8px; color: ' + bgColor + '; font-size: 1.1rem;"></i>';
            basemapsHtml += '<span class="basemap-label">' + name + '</span>'; 
            basemapsHtml += '</label>';
            basemapIndex++;
        }
        basemapsHtml += '</div>';
        var basemapsControlDiv = document.getElementById('basemaps-control');
        basemapsControlDiv.innerHTML = basemapsHtml;
        
        var basemapRadios = basemapsControlDiv.querySelectorAll('input[type="radio"]');
        basemapRadios.forEach(function(radio) {
            radio.addEventListener('change', function() {
                var basemapName = this.value;
                for (var name in basemaps) {
                    if (map.hasLayer(basemaps[name])) {
                        map.removeLayer(basemaps[name]);
                    }
                }
                map.addLayer(basemaps[basemapName]);
            });
        });

        // Layers control
        overlays = {
            "Régions": layer_Region_1,
            "Départements": layer_Departement_2,
            "Arrondissements": layer_Arrondissement_3,
            "Routes": layer_Routes_4,
            "Localités": cluster_localites_5
        };
        
        var layersHtml = '<div style="padding: 10px; font-size: 0.9rem;">';
        layersHtml += '<h6 class="panel-title" style="margin-bottom: 10px; font-weight: 700; border-bottom: 2px solid #667eea; padding-bottom: 8px;">Couches visibles</h6>'; 
        
        for (var overlayName in overlays) {
            var layer = overlays[overlayName];
            var isOnMap = map.hasLayer(layer);
            layersHtml += '<div style="margin-bottom: 8px; display: flex; align-items: center;">';
            layersHtml += '<input type="checkbox" name="layers-overlay" value="' + overlayName + '" id="overlay-' + overlayName + '"' + (isOnMap ? ' checked' : '') + ' style="margin-right: 8px; cursor: pointer;">';
            layersHtml += '<label for="overlay-' + overlayName + '" style="cursor: pointer; margin: 0;">' + overlayName + '</label>';
            layersHtml += '</div>';
        }
        layersHtml += '</div>';
        
        document.getElementById('layers-control').innerHTML = layersHtml;
        
        var overlayCheckboxes = document.querySelectorAll('input[name="layers-overlay"]');
        overlayCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                var overlayName = this.value;
                var layer = overlays[overlayName];
                if (this.checked) {
                    map.addLayer(layer);
                } else {
                    map.removeLayer(layer);
                }
            });
        });

        setBounds();

        // === Theme & Animations controls ===
        function showTempMessage(msg, timeout) {
            timeout = timeout || 2000;
            var d = document.createElement('div');
            d.className = 'toast-message';
            d.style.position = 'fixed'; d.style.right = '18px'; d.style.top = '18px';
            d.style.padding = '10px 14px'; d.style.background = 'rgba(8,12,24,0.9)'; d.style.color = '#fff';
            d.style.borderRadius = '6px'; d.style.zIndex = 9999; d.style.boxShadow = '0 6px 18px rgba(0,0,0,0.3)';
            d.innerText = msg;
            document.body.appendChild(d);
            setTimeout(function(){ d.style.transition = 'opacity 0.3s ease'; d.style.opacity = 0; setTimeout(function(){ d.remove(); }, 350); }, timeout);
        }

        var _themeList = ['claire','dark'];
        function applyTheme(theme) {
            var root = document.documentElement;
            // remove any existing theme-* classes to avoid leftovers
            Array.from(root.classList).filter(function(c){ return c.indexOf('theme-') === 0; }).forEach(function(c){ root.classList.remove(c); });
            // ensure a class is set for the theme (claire as explicit class)
            var addClass = 'theme-' + (theme || 'claire');
            root.classList.add(addClass);
            localStorage.setItem('sig_theme', theme);
            var friendly = { claire: 'Claire', dark: 'Sombre' };
            showTempMessage('Thème appliqué : ' + (friendly[theme] || theme || 'Claire'));
            // update UI inputs if they exist
            var themeRadio = document.querySelector('input[name="theme"][value="'+theme+'"]'); if (themeRadio) themeRadio.checked = true;
        }
        function applyAnimations(enabled) {
            if (enabled) document.documentElement.classList.add('animations-enabled'); else document.documentElement.classList.remove('animations-enabled');
            localStorage.setItem('sig_animations', enabled ? '1' : '0');
        }

        document.addEventListener('DOMContentLoaded', function(){
            // restore saved preferences (or defaults)
            var storedTheme = localStorage.getItem('sig_theme') || 'claire';
            var storedAnim = localStorage.getItem('sig_animations');
            var animEnabled = (storedAnim === null ? true : storedAnim === '1');
            applyTheme(storedTheme);
            applyAnimations(animEnabled);
            // update UI inputs
            var themeRadio = document.querySelector('input[name="theme"][value="'+storedTheme+'"]'); if (themeRadio) themeRadio.checked = true;
            var animCheckbox = document.getElementById('animations-toggle'); if (animCheckbox) animCheckbox.checked = animEnabled;
            // event wiring
            var themeRadios = document.querySelectorAll('input[name="theme"]');
            themeRadios.forEach(function(r){ r.addEventListener('change', function(){ applyTheme(this.value); }); });
            if (animCheckbox) { animCheckbox.addEventListener('change', function(){ applyAnimations(this.checked); }); }

            // navbar theme menu wiring
            var themeItems = document.querySelectorAll('.theme-select');
            themeItems.forEach(function(it){ it.addEventListener('click', function(ev){ ev.preventDefault(); var t = this.getAttribute('data-theme'); applyTheme(t); } ); });
            var themeCycle = document.getElementById('theme-cycle');
            if (themeCycle) {
                themeCycle.addEventListener('click', function(ev){ ev.preventDefault(); var cur = localStorage.getItem('sig_theme') || 'claire'; var idx = _themeList.indexOf(cur); var next = _themeList[(idx + 1) % _themeList.length]; applyTheme(next); });
            }

            // Inject small theme controls in right panel (if missing) for quick access
            var basemapsControlDiv = document.getElementById('basemaps-control');
            if (basemapsControlDiv && !document.getElementById('theme-controls')) {
                var tHtml = '<div id="theme-controls" class="control-card" style="margin-top:12px">';
                tHtml += '<div class="legend-title"><i class="fas fa-palette"></i> Thèmes</div>';
                _themeList.forEach(function(t){
                    var label = (t==='claire' ? 'Claire' : t==='dark' ? 'Sombre' : '');
                    var color = (t==='claire' ? '#ffffff' : t==='dark' ? '#071022' : '#ffffff');
                    tHtml += '<label style="display:flex; align-items:center; gap:8px; margin-bottom:6px"><input type="radio" name="theme" value="'+t+'" style="margin-right:8px"> <span class="swatch" style="background:'+color+'"></span> '+label+'</label>';
                });
                tHtml += '<div style="margin-top:6px"><label style="display:flex; align-items:center; gap:8px"><input type="checkbox" id="animations-toggle-duplicate"> <span>Animations</span></label></div>';
                tHtml += '</div>';
                basemapsControlDiv.insertAdjacentHTML('beforeend', tHtml);
                // wire radios
                var themeRadios = basemapsControlDiv.querySelectorAll('input[name="theme"]');
                themeRadios.forEach(function(r){ r.addEventListener('change', function(){ applyTheme(this.value); }); });
                var animCheckboxDup = document.getElementById('animations-toggle-duplicate');
                var animCheckboxOrig = document.getElementById('animations-toggle');
                if (animCheckboxDup) {
                    animCheckboxDup.checked = (animCheckboxOrig ? animCheckboxOrig.checked : document.documentElement.classList.contains('animations-enabled'));
                    animCheckboxDup.addEventListener('change', function(){ applyAnimations(this.checked); if (animCheckboxOrig) animCheckboxOrig.checked = this.checked; });
                }
                // reflect stored theme
                var storedTheme = localStorage.getItem('sig_theme') || 'claire';
                var storedRadio = basemapsControlDiv.querySelector('input[name="theme"][value="'+storedTheme+'"]');
                if (storedRadio) storedRadio.checked = true;
            }
        });

        // Run initialization immediately too
        (function(){
            var storedTheme = localStorage.getItem('sig_theme') || 'claire';
            var storedAnim = localStorage.getItem('sig_animations');
            var animEnabled = (storedAnim === null ? true : storedAnim === '1');
            applyTheme(storedTheme);
            applyAnimations(animEnabled);
            var themeRadio = document.querySelector('input[name="theme"][value="'+storedTheme+'"]'); if (themeRadio) themeRadio.checked = true;
            var animCheckbox = document.getElementById('animations-toggle'); if (animCheckbox) animCheckbox.checked = animEnabled;
            var themeRadios = document.querySelectorAll('input[name="theme"]');
            themeRadios.forEach(function(r){ r.addEventListener('change', function(){ applyTheme(this.value); }); });
            if (animCheckbox) { animCheckbox.addEventListener('change', function(){ applyAnimations(this.checked); }); }
        })();

        // ==================== FONCTIONS POUR LES REQUÊTES ===================="}
        
        // Gestion des modaux
        var closeButtons = document.querySelectorAll('.close-modal');
        closeButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                var modalId = this.getAttribute('data-modal');
                document.getElementById(modalId).style.display = 'none';
                spatialQueryActive = false;
            });
        });

        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('query-modal')) {
                event.target.style.display = 'none';
                spatialQueryActive = false;
            }
        });

        // Fonction pour activer la requête spatiale
        function enableSpatialQuery() {
            spatialQueryActive = true;
            currentQueryLayerType = document.getElementById('spatial-layer-type').value;
            var resultsDiv = document.getElementById('spatial-results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p class="spatial-note"><i class="fas fa-mouse-pointer"></i> Mode requête spatiale activé pour: <strong>' + currentQueryLayerType + '</strong>. Cliquez sur un élément de la carte...</p>';
        }

        // Fonction pour afficher le résultat de la requête spatiale
        function showSpatialResult(feature, layerType) {
            var resultsDiv = document.getElementById('spatial-results');
            resultsDiv.innerHTML = '<h4>📍 Résultat de la requête spatiale :</h4>';
            
            var resultHtml = '<div class="result-item">';
            resultHtml += '<h5 class="result-title" style="margin: 0 0 12px 0; font-weight: 700;"><i class="fas fa-info-circle"></i> ' + layerType + '</h5>'; 
            
            for (var key in feature.properties) {
                var value = feature.properties[key];
                if (value != null && value !== '') {
                    resultHtml += '<p style="margin: 6px 0; padding-left: 10px; border-left: 3px solid #667eea;"><strong>' + key + ':</strong> ' + value + '</p>';
                }
            }
            
            // Informations géométriques
            if (feature.geometry) {
                resultHtml += '<hr style="margin: 12px 0; border-color: #e0e7ff;">';
                resultHtml += '<p style="margin: 6px 0;"><strong>Type de géométrie:</strong> ' + feature.geometry.type + '</p>';
            }
            
            resultHtml += '</div>';
            resultsDiv.innerHTML += resultHtml;
        }

        // Fonction pour mettre à jour les champs disponibles pour la requête attributaire
        function updateAttributeFields() {
            var layer = document.getElementById('attribute-layer').value;
            var fieldSelect = document.getElementById('attribute-field');
            fieldSelect.innerHTML = '';
            
            var fields = [];
            switch(layer) {
                case 'region':
                    fields = ['Région'];
                    break;
                case 'departement':
                    fields = ['Département', 'Région'];
                    break;
                case 'arrondissement':
                    fields = ['Arrondissement', 'Département', 'Région'];
                    break;
                case 'routes':
                    fields = ['Type'];
                    break;
                case 'localite':
                    fields = ['NOM', 'TYPE', 'POPULATION', 'DEPARTEMENT', 'REGION'];
                    break;
            }
            
            fields.forEach(function(field) {
                var option = document.createElement('option');
                option.value = field;
                option.textContent = field;
                fieldSelect.appendChild(option);
            });
        }

        // Fonction pour exécuter la requête attributaire
        function executeAttributeQuery() {
            var layerType = document.getElementById('attribute-layer').value;
            var field = document.getElementById('attribute-field').value;
            var operator = document.getElementById('attribute-operator').value;
            var value = document.getElementById('attribute-value').value;

            if (!value) {
                alert('Veuillez entrer une valeur pour la recherche');
                return;
            }

            var resultsDiv = document.getElementById('attribute-results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<h4>🔍 Résultats de la requête attributaire :</h4>';
            resultsDiv.innerHTML += '<p class="muted-note" style="margin-bottom: 15px;"><strong>Recherche:</strong> ' + field + ' ' + operator + ' "' + value + '" dans ' + layerType + '</p>';

            var results = [];
            var targetLayer = null;
            
            switch(layerType) {
                case 'region':
                    targetLayer = layer_Region_1;
                    break;
                case 'departement':
                    targetLayer = layer_Departement_2;
                    break;
                case 'arrondissement':
                    targetLayer = layer_Arrondissement_3;
                    break;
                case 'routes':
                    targetLayer = layer_Routes_4;
                    break;
                case 'localite':
                    targetLayer = layer_localites_5;
                    break;
            }

            if (targetLayer) {
                targetLayer.eachLayer(function(layer) {
                    var feature = layer.feature;
                    var featureValue = feature.properties[field];
                    var match = false;

                    if (featureValue != null) {
                        switch(operator) {
                            case 'equals':
                                match = featureValue.toString().toLowerCase() === value.toLowerCase();
                                break;
                            case 'contains':
                                match = featureValue.toString().toLowerCase().includes(value.toLowerCase());
                                break;
                            case 'greater':
                                match = parseFloat(featureValue) > parseFloat(value);
                                break;
                            case 'less':
                                match = parseFloat(featureValue) < parseFloat(value);
                                break;
                        }
                    }

                    if (match) {
                        results.push({feature: feature, layer: layer});
                    }
                });
            }

            if (results.length === 0) {
                resultsDiv.innerHTML += '<p class="error-note" style="padding: 15px; background: #fee; border-radius: 6px;"><i class="fas fa-exclamation-circle"></i> Aucun résultat trouvé.</p>';
            } else {
                resultsDiv.innerHTML += '<p class="success-note" style="font-weight: 600; margin-bottom: 10px;"><i class="fas fa-check-circle"></i> ' + results.length + ' résultat(s) trouvé(s)</p>';
                
                results.forEach(function(result, index) {
                    var feature = result.feature;
                    var resultHtml = '<div class="result-item" onclick="highlightResult(' + index + ')">';
                    resultHtml += '<h6 style="margin: 0 0 8px 0; color: #667eea; font-weight: 700;">Résultat ' + (index + 1) + '</h6>';
                    
                    for (var key in feature.properties) {
                        var val = feature.properties[key];
                        if (val != null && val !== '') {
                            var highlight = (key === field) ? 'background: #fff3cd; padding: 2px 6px; border-radius: 3px;' : '';
                            resultHtml += '<p style="margin: 4px 0;"><strong>' + key + ':</strong> <span style="' + highlight + '">' + val + '</span></p>';
                        }
                    }
                    
                    resultHtml += '</div>';
                    resultsDiv.innerHTML += resultHtml;
                });
                
                // Stocker les résultats pour la fonction highlightResult
                window.queryResults = results;
            }
        }

        // Fonction pour mettre en évidence un résultat sur la carte
        function highlightResult(index) {
            if (window.queryResults && window.queryResults[index]) {
                var result = window.queryResults[index];
                var layer = result.layer;
                
                // Zoomer sur l'entité
                if (layer.getBounds) {
                    map.fitBounds(layer.getBounds());
                } else if (layer.getLatLng) {
                    map.setView(layer.getLatLng(), 12);
                }
                
                // Ouvrir le popup
                layer.openPopup();
                
                // Mettre en surbrillance temporairement
                if (layer.setStyle) {
                    var originalStyle = layer.options;
                    layer.setStyle({
                        fillColor: '#ffff00',
                        fillOpacity: 0.7,
                        color: '#ff0000',
                        weight: 3
                    });
                    
                    setTimeout(function() {
                        layer.setStyle(originalStyle);
                    }, 2000);
                }
            }
        }

        // Fonctions pour les menus
        document.getElementById('home').addEventListener('click', function(e) {
            e.preventDefault();
            map.setView([14.4974, -14.4524], 7);
        });
        
        document.getElementById('about').addEventListener('click', function(e) {
            e.preventDefault();
            var aboutModal = new bootstrap.Modal(document.getElementById('aboutModal'));
            aboutModal.show();
        });
        
        document.getElementById('catalog').addEventListener('click', function(e) {
            e.preventDefault();
            var catalogInfo = '📁 Catalogue des données disponibles:\n\n';
            catalogInfo += '📍 Régions du Sénégal\n';
            catalogInfo += '📍 Départements\n';
            catalogInfo += '📍 Arrondissements\n';
            catalogInfo += '🛣️ Routes\n';
            catalogInfo += '🏘️ Localités\n\n';
            catalogInfo += 'Utilisez les requêtes pour explorer ces données !';
            alert(catalogInfo);
        });
        
        document.getElementById('spatial-query').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('spatial-modal').style.display = 'block';
        });

        document.getElementById('attribute-query').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('attribute-modal').style.display = 'block';
            updateAttributeFields();
        });
        
        document.getElementById('download-csv').addEventListener('click', function(e) {
            e.preventDefault();
            alert('Export CSV - Fonctionnalité à implémenter');
        });
        
        document.getElementById('download-geojson').addEventListener('click', function(e) {
            e.preventDefault();
            alert('Export GeoJSON - Fonctionnalité à implémenter');
        });
        
        document.getElementById('measure').addEventListener('click', function(e) {
            e.preventDefault();
            alert('Outil de mesure activé - Utilisez le contrôle sur la carte');
        });
        
        document.getElementById('zoom-in').addEventListener('click', function(e) {
            e.preventDefault();
            map.zoomIn();
        });
        
        document.getElementById('zoom-out').addEventListener('click', function(e) {
            e.preventDefault();
            map.zoomOut();
        });
        
        document.getElementById('home-view').addEventListener('click', function(e) {
            e.preventDefault();
            map.setView([14.4974, -14.4524], 7);
        });
        
        document.getElementById('print').addEventListener('click', function(e) {
            e.preventDefault();
            window.print();
        });
        
        document.getElementById('search').addEventListener('click', function(e) {
            e.preventDefault();
            alert('Utilisez la barre de recherche sur la carte pour chercher des localités');
        });

        // --- PWA: service worker registration, install prompt handling ---
        (function() {
            let deferredPrompt = null;
            window.addEventListener('beforeinstallprompt', function(e) {
                e.preventDefault();
                deferredPrompt = e;
                var installLi = document.getElementById('install-li');
                if (installLi) installLi.style.display = 'block';
            });

            var installBtn = document.getElementById('install-btn');
            if (installBtn) {
                installBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then(function(choiceResult) {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('User accepted the PWA install');
                            }
                            deferredPrompt = null;
                            var installLi = document.getElementById('install-li');
                            if (installLi) installLi.style.display = 'none';
                        });
                    } else {
                        alert('Installation non disponible');
                    }
                });
            }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(function(reg) {
                    console.log('Service worker registered.', reg);
                }).catch(function(err) {
                    console.warn('Service worker registration failed:', err);
                });
            }
        })();

        // --- Geolocation utilities (simple UX) ---
        (function() {
            var userMarker = null;
            var userCircle = null;
            var watchId = null;

            function clearUserLocation() {
                if (userMarker) { map.removeLayer(userMarker); userMarker = null; }
                if (userCircle) { map.removeLayer(userCircle); userCircle = null; }
                if (watchId !== null && navigator.geolocation) { navigator.geolocation.clearWatch(watchId); watchId = null; }
            }

            function showPosition(position, center) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                var acc = position.coords.accuracy || 0;

                if (userMarker) {
                    userMarker.setLatLng([lat,lng]);
                    userCircle.setLatLng([lat,lng]).setRadius(acc);
                } else {
                    var icon = L.icon({ iconUrl: 'images/icons/icon-192.svg', iconSize: [36,36] });
                    userMarker = L.marker([lat,lng], {icon: icon}).addTo(map).bindPopup('Vous êtes ici').openPopup();
                    userCircle = L.circle([lat,lng], {radius: acc, color: '#1e90ff', fillColor: '#1e90ff', fillOpacity: 0.12}).addTo(map);
                }
                if (center) map.setView([lat,lng], 14);
                var coordEl = document.getElementById('coordinates');
                if (coordEl) coordEl.innerHTML = 'Lat: ' + lat.toFixed(5) + ', Lng: ' + lng.toFixed(5);
            }

            function startGeolocation() {
                if (!('geolocation' in navigator)) { alert('Géolocalisation non supportée par ce navigateur'); return; }
                navigator.geolocation.getCurrentPosition(function(pos) { showPosition(pos, true); }, function(err){ alert('Erreur de géolocalisation: ' + err.message); }, { enableHighAccuracy: true, timeout: 10000 });
                watchId = navigator.geolocation.watchPosition(function(pos){ showPosition(pos, false); }, function(err){ console.warn('watch error', err); }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 });
            }

            var geoBtn = document.getElementById('geolocate-btn');
            if (geoBtn) geoBtn.addEventListener('click', function(e){ e.preventDefault(); startGeolocation(); });
        })();
        </script>
    </body>
</html>